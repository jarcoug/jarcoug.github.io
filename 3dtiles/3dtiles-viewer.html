<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Tiles æ•°æ®é¢„è§ˆå™¨</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100%;
            height: 100%;
        }

        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 400px;
            max-width: 450px;
            z-index: 1000;
            max-height: 90vh;
            overflow-y: auto;
        }

        .control-panel h2 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-load {
            background-color: #4CAF50;
            color: white;
        }

        .btn-load:hover {
            background-color: #45a049;
        }

        .btn-clear {
            background-color: #f44336;
            color: white;
        }

        .btn-clear:hover {
            background-color: #da190b;
        }

        .btn-example {
            background-color: #2196F3;
            color: white;
        }

        .btn-example:hover {
            background-color: #0b7dda;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
            display: none;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .tips {
            margin-top: 15px;
            padding: 12px;
            background-color: #e8f5e9;
            border: 1px solid #4CAF50;
            border-radius: 4px;
            font-size: 12px;
            color: #2e7d32;
        }

        .tips strong {
            display: block;
            margin-bottom: 8px;
            color: #1b5e20;
        }

        .tips ul {
            margin-left: 20px;
            margin-top: 5px;
        }

        .tips li {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .code-block {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            margin-top: 8px;
            overflow-x: auto;
        }

        .tab-group {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 8px 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .instruction-box {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 12px;
            margin-top: 15px;
        }

        .instruction-box h4 {
            margin: 0 0 8px 0;
            color: #856404;
            font-size: 13px;
        }

        .instruction-box ol {
            margin-left: 20px;
            font-size: 12px;
            color: #856404;
        }

        .instruction-box li {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        /* æ•°æ®é¡¹æ ·å¼ */
        .data-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-item-info {
            flex: 1;
            font-size: 12px;
            color: #495057;
            word-break: break-all;
        }

        .data-item-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 4px;
        }

        .data-item-url {
            color: #6c757d;
            font-size: 11px;
        }

        .btn-remove {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .btn-remove:hover {
            background-color: #c82333;
        }

        /* ç¤ºä¾‹æ•°æ®checkboxæ ·å¼ */
        .example-item {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-item:hover {
            background: #f8f9fa;
            border-color: #4CAF50;
        }

        .example-item.selected {
            background: #e8f5e9;
            border-color: #4CAF50;
        }

        .example-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .example-item label {
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            margin: 0;
        }

        .example-details {
            flex: 1;
        }

        .example-title {
            font-weight: 600;
            color: #212529;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .example-desc {
            font-size: 11px;
            color: #6c757d;
            line-height: 1.4;
        }
    </style>
</head>
<body>
<div id="cesiumContainer"></div>

<div class="control-panel">
    <h2>ğŸŒ 3D Tiles æ•°æ®é¢„è§ˆå™¨</h2>

    <div class="tab-group">
        <button class="tab active" data-tab="url">åœ¨çº¿/æœ¬åœ°URL</button>
        <button class="tab" data-tab="example">ç¤ºä¾‹æ•°æ®</button>
    </div>

    <!-- URLåŠ è½½ -->
    <div class="tab-content active" id="url-content">
        <div class="input-group">
            <label>ğŸ“¡ æ•°æ®åœ°å€ï¼ˆåœ¨çº¿URL æˆ– æœ¬åœ°æœåŠ¡å™¨ï¼‰ï¼š</label>
            <input type="text" id="urlInput" placeholder="https://pelican-public.s3.amazonaws.com/3dtiles/agi-hq/tileset.json" value="https://pelican-public.s3.amazonaws.com/3dtiles/agi-hq/tileset.json">
        </div>
        <div class="button-group">
            <button class="btn-load" id="loadUrlBtn">åŠ è½½æ•°æ®</button>
            <button class="btn-example" id="addUrlBtn">â• æ·»åŠ åœ°å€</button>
        </div>

        <!-- å·²åŠ è½½çš„æ•°æ®åˆ—è¡¨ -->
        <div id="loadedUrlsList" style="margin-top: 15px;"></div>

        <div class="instruction-box">
            <h4>ğŸ’¡ å¦‚ä½•åŠ è½½æœ¬åœ°3D Tilesæ•°æ®ï¼š</h4>
            <ol>
                <li><strong>å¯åŠ¨æœ¬åœ°HTTPæœåŠ¡å™¨</strong>ï¼ˆåœ¨æ•°æ®æ–‡ä»¶å¤¹ä¸­ï¼‰ï¼š
                    <div class="code-block">
                        # Python 3<br>
                        python -m http.server 8080<br><br>
                        # æˆ– Python 2<br>
                        python -m SimpleHTTPServer 8080<br><br>
                        # æˆ– Node.js<br>
                        npx http-server -p 8080 --cors
                    </div>
                </li>
                <li><strong>è¾“å…¥æœ¬åœ°åœ°å€</strong>ï¼š<br>
                    å¦‚æœtileset.jsonåœ¨æœåŠ¡å™¨æ ¹ç›®å½•ï¼š<br>
                    <code style="background:#f0f0f0;padding:2px 6px;border-radius:3px;">http://localhost:8080/tileset.json</code><br><br>
                    å¦‚æœåœ¨å­æ–‡ä»¶å¤¹ä¸­ï¼š<br>
                    <code style="background:#f0f0f0;padding:2px 6px;border-radius:3px;">http://localhost:8080/folder/tileset.json</code>
                </li>
                <li><strong>ç‚¹å‡»"åŠ è½½"</strong>æŒ‰é’®</li>
            </ol>
        </div>

        <div class="tips">
            <strong>âœ… æ”¯æŒçš„æ•°æ®æºï¼š</strong>
            <ul>
                <li><strong>åœ¨çº¿URLï¼š</strong> https://example.com/tileset.json</li>
                <li><strong>æœ¬åœ°æœåŠ¡å™¨ï¼š</strong> http://localhost:8080/tileset.json</li>
                <li><strong>å±€åŸŸç½‘ï¼š</strong> http://192.168.1.100:8080/tileset.json</li>
            </ul>
        </div>
    </div>

    <!-- ç¤ºä¾‹æ•°æ® -->
    <div class="tab-content" id="example-content">
        <div class="input-group">
            <label>ğŸ™ï¸ ç¤ºä¾‹æ•°æ®é›†ï¼ˆå‹¾é€‰å³æ˜¾ç¤ºï¼Œå–æ¶ˆå³éšè—ï¼‰ï¼š</label>
            <div id="exampleList" style="margin-top: 10px;">
                <!-- ç¤ºä¾‹æ•°æ®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ¸…é™¤æŒ‰é’® -->
    <div class="button-group">
        <button class="btn-clear" id="clearBtn">æ¸…é™¤æ•°æ®</button>
    </div>

    <div class="status" id="status"></div>
</div>

<script>
    // Cesium token
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5N2UyMjcwOS00MDY1LTQxYjEtYjZjMy00YTU0ZTg5MmViYWQiLCJpZCI6ODAzMDYsImlhdCI6MTY0Mjc0ODI2MX0.dkwAL1CcljUV7NA7fDbhXXnmyZQU_c-G5zRx8PtEcxE';

    let viewer = null;
    let loadedTilesets = []; // å­˜å‚¨æ‰€æœ‰å·²åŠ è½½çš„tilesetå¯¹è±¡
    let viewerReady = false;
    let loadingTilesets = new Map(); // è·Ÿè¸ªæ­£åœ¨åŠ è½½çš„tilesetï¼Œé˜²æ­¢é‡å¤åŠ è½½
    let checkboxDebounceTimers = {}; // é˜²æŠ–å®šæ—¶å™¨

    // ç¤ºä¾‹æ•°æ®é›†é…ç½®
    const EXAMPLE_DATA = [
        {
            id: 'agi-hq',
            name: 'agi-hq',
            url: 'https://pelican-public.s3.amazonaws.com/3dtiles/agi-hq/tileset.json',
            description: 'agi-hq'
        },
        {
            id: 'MetadataGranularities',
            name: 'MetadataGranularities',
            url: 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/1.1/MetadataGranularities/tileset.json',
            description: 'MetadataGranularities'
        },
        {
            id: 'TilesetWithTreeBillboards',
            name: 'TilesetWithTreeBillboards',
            url: 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/1.0/TilesetWithTreeBillboards/tileset.json',
            description: 'TilesetWithTreeBillboards'
        },
        {
            id: 'TilesetWithDiscreteLOD',
            name: 'TilesetWithDiscreteLOD',
            url: 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/1.0/TilesetWithDiscreteLOD/tileset.json',
            description: 'TilesetWithDiscreteLOD'
        },
        {
            id: 'TilesetWithRequestVolume',
            name: 'TilesetWithRequestVolume',
            url: 'https://raw.githubusercontent.com/CesiumGS/3d-tiles-samples/main/1.0/TilesetWithRequestVolume/tileset.json',
            description: 'TilesetWithRequestVolume'
        }
    ];

    // åˆå§‹åŒ–Cesium Viewer
    function initViewer() {
        try {
            viewer = new Cesium.Viewer('cesiumContainer', {
                animation: false,
                timeline: false,
                baseLayerPicker: true,
                geocoder: true,
                homeButton: true,
                sceneModePicker: true,
                navigationHelpButton: true,
                fullscreenButton: true,
                vrButton: false
            });

            viewer.scene.globe.depthTestAgainstTerrain = true;
            viewerReady = true;
            console.log('Cesium Viewer åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('Vieweråˆå§‹åŒ–é”™è¯¯:', error);
            throw error;
        }
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = 'status ' + type;

        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 8000);
        }
    }

    // æ ‡ç­¾é¡µåˆ‡æ¢
    function initTabs() {
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');

                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));

                this.classList.add('active');
                document.getElementById(targetTab + '-content').classList.add('active');
            });
        });
    }

    // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®åˆ—è¡¨
    function initExampleList() {
        const exampleList = document.getElementById('exampleList');
        exampleList.innerHTML = '';

        EXAMPLE_DATA.forEach((example, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'example-item';
            itemDiv.innerHTML = `
                <label>
                    <input type="checkbox" style="width:15px" id="example-${example.id}" value="${example.url}" data-name="${example.name}" data-example-id="${example.id}">
                    <div class="example-details">
                        <div class="example-title">${example.name}</div>
                        <div class="example-desc">${example.description}</div>
                    </div>
                </label>
            `;

            // ç‚¹å‡»æ•´ä¸ªitemæ—¶åˆ‡æ¢checkbox
            itemDiv.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    const checkbox = itemDiv.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });

            // checkboxå˜åŒ–æ—¶ç«‹å³åŠ è½½æˆ–ç§»é™¤æ•°æ®
            const checkbox = itemDiv.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', async function() {
                const isChecked = this.checked;
                itemDiv.classList.toggle('selected', isChecked);

                const url = this.value;
                const name = this.dataset.name;
                const exampleId = this.dataset.exampleId;

                // æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–å®šæ—¶å™¨
                if (checkboxDebounceTimers[exampleId]) {
                    clearTimeout(checkboxDebounceTimers[exampleId]);
                }

                // ä½¿ç”¨é˜²æŠ–é¿å…å¿«é€Ÿåˆ‡æ¢å¯¼è‡´çš„é—®é¢˜
                checkboxDebounceTimers[exampleId] = setTimeout(async () => {
                    if (isChecked) {
                        // å‹¾é€‰æ—¶åŠ è½½æ•°æ®
                        await loadTileset(url, name, exampleId);
                    } else {
                        // å–æ¶ˆå‹¾é€‰æ—¶ç§»é™¤æ•°æ®
                        removeExampleTileset(exampleId);
                    }
                }, 300); // 300msé˜²æŠ–å»¶è¿Ÿ
            });

            exampleList.appendChild(itemDiv);
        });
    }

    // ä»URLåŠ è½½å•ä¸ªtileset
    async function loadFromUrl() {
        if (!viewerReady || !viewer) {
            showStatus('âŒ åœ°å›¾è§†å›¾å°šæœªåˆå§‹åŒ–ï¼Œè¯·ç¨å€™é‡è¯•', 'error');
            return;
        }

        const urlInput = document.getElementById('urlInput').value.trim();

        if (!urlInput) {
            showStatus('è¯·è¾“å…¥æ•°æ®åœ°å€', 'error');
            return;
        }

        await loadTileset(urlInput, 'è‡ªå®šä¹‰æ•°æ®');
    }

    // é€šç”¨åŠ è½½tilesetå‡½æ•°
    async function loadTileset(url, name, exampleId = null) {
        if (!viewerReady || !viewer) {
            showStatus('âŒ åœ°å›¾è§†å›¾å°šæœªåˆå§‹åŒ–ï¼Œè¯·ç¨å€™é‡è¯•', 'error');
            return;
        }

        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½
        if (loadingTilesets.has(url)) {
            showStatus(`â³ "${name}" æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...`, 'info');
            return;
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½
        const existing = loadedTilesets.find(t => t.url === url);
        if (existing) {
            showStatus(`âš ï¸ "${name}" å·²ç»åŠ è½½`, 'info');
            try {
                await viewer.zoomTo(existing.tileset);
            } catch (error) {
                console.warn('é£åˆ°tilesetå¤±è´¥:', error);
            }
            return;
        }

        // æ ‡è®°ä¸ºæ­£åœ¨åŠ è½½
        loadingTilesets.set(url, true);

        try {
            showStatus(`æ­£åœ¨åŠ è½½ "${name}"...`, 'info');

            // åŠ è½½3D Tileset
            const tileset = await Cesium.Cesium3DTileset.fromUrl(url, {
                maximumScreenSpaceError: 16,
                maximumMemoryUsage: 512
            });

            // æ£€æŸ¥åœ¨åŠ è½½æœŸé—´æ˜¯å¦å·²è¢«å–æ¶ˆ
            if (!loadingTilesets.has(url)) {
                console.log('åŠ è½½å·²è¢«å–æ¶ˆ:', name);
                tileset.destroy();
                return;
            }

            viewer.scene.primitives.add(tileset);

            // å­˜å‚¨tilesetä¿¡æ¯
            const tilesetInfo = {
                id: Date.now().toString(),
                name: name,
                url: url,
                tileset: tileset,
                exampleId: exampleId // æ ‡è®°ç¤ºä¾‹æ•°æ®ID
            };
            loadedTilesets.push(tilesetInfo);

            // é£è¡Œåˆ°tilesetä½ç½®
            try {
                await viewer.zoomTo(tileset, new Cesium.HeadingPitchRange(
                    0.0,
                    -0.5,
                    tileset.boundingSphere.radius * 2.0
                ));
            } catch (error) {
                console.warn('é£åˆ°tilesetå¤±è´¥:', error);
            }

            updateLoadedList();
            showStatus(`âœ… "${name}" åŠ è½½æˆåŠŸï¼`, 'success');

        } catch (error) {
            console.error('åŠ è½½å¤±è´¥:', error);

            let errorMsg = `âŒ åŠ è½½ "${name}" å¤±è´¥: ${error.message}`;

            // æä¾›æ›´æœ‰å¸®åŠ©çš„é”™è¯¯ä¿¡æ¯
            if (error.message.includes('404') || error.message.includes('Failed to fetch')) {
                errorMsg += '\n\nğŸ’¡ è¯·ç¡®è®¤ï¼š\n1. URLåœ°å€æ­£ç¡®\n2. æ•°æ®æ–‡ä»¶å­˜åœ¨ä¸”å¯è®¿é—®\n3. å¦‚æœæ˜¯æœ¬åœ°æ•°æ®ï¼Œè¯·ç¡®ä¿å·²å¯åŠ¨HTTPæœåŠ¡å™¨';
            } else if (error.message.includes('CORS')) {
                errorMsg += '\n\nğŸ’¡ CORSé”™è¯¯ï¼šå¯åŠ¨æœåŠ¡å™¨æ—¶æ·»åŠ  --cors å‚æ•°';
            }

            showStatus(errorMsg, 'error');

            // å¦‚æœæ˜¯ç¤ºä¾‹æ•°æ®åŠ è½½å¤±è´¥ï¼Œå–æ¶ˆå‹¾é€‰
            if (exampleId) {
                const checkbox = document.getElementById(`example-${exampleId}`);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.parentElement.parentElement.classList.remove('selected');
                }
            }
        } finally {
            // ç§»é™¤åŠ è½½æ ‡è®°
            loadingTilesets.delete(url);
        }
    }

    // æ›´æ–°å·²åŠ è½½æ•°æ®åˆ—è¡¨
    function updateLoadedList() {
        const listDiv = document.getElementById('loadedUrlsList');

        if (loadedTilesets.length === 0) {
            listDiv.innerHTML = '';
            return;
        }

        listDiv.innerHTML = '<div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #333;">å·²åŠ è½½çš„æ•°æ®ï¼š</div>';

        loadedTilesets.forEach((item) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'data-item';
            itemDiv.innerHTML = `
                <div class="data-item-info">
                    <div class="data-item-name">${item.name}</div>
                    <div class="data-item-url">${item.url}</div>
                </div>
                <button class="btn-remove" onclick="removeTileset('${item.id}')">åˆ é™¤</button>
            `;

            // ç‚¹å‡»é¡¹ç›®æ—¶é£åˆ°è¯¥æ•°æ®
            itemDiv.querySelector('.data-item-info').style.cursor = 'pointer';
            itemDiv.querySelector('.data-item-info').addEventListener('click', function() {
                try {
                    if (item.tileset && !item.tileset.isDestroyed()) {
                        viewer.zoomTo(item.tileset);
                    }
                } catch (error) {
                    console.warn('é£åˆ°tilesetå¤±è´¥:', error);
                    showStatus('æ— æ³•å®šä½åˆ°è¯¥æ•°æ®', 'error');
                }
            });

            listDiv.appendChild(itemDiv);
        });
    }

    // åˆ é™¤æŒ‡å®šçš„tileset
    window.removeTileset = function(id) {
        const index = loadedTilesets.findIndex(t => t.id === id);
        if (index !== -1) {
            const item = loadedTilesets[index];

            try {
                // å®‰å…¨åœ°ç§»é™¤å’Œé”€æ¯tileset
                if (item.tileset && !item.tileset.isDestroyed()) {
                    viewer.scene.primitives.remove(item.tileset);
                    item.tileset.destroy();
                }
            } catch (error) {
                console.warn('ç§»é™¤tilesetæ—¶å‡ºé”™:', error);
            }

            // å¦‚æœæ˜¯ç¤ºä¾‹æ•°æ®ï¼Œå–æ¶ˆå¯¹åº”çš„checkbox
            if (item.exampleId) {
                const checkbox = document.getElementById(`example-${item.exampleId}`);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.parentElement.parentElement.classList.remove('selected');
                }
            }

            // å–æ¶ˆåŠ è½½æ ‡è®°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            loadingTilesets.delete(item.url);

            loadedTilesets.splice(index, 1);
            updateLoadedList();
            showStatus(`å·²åˆ é™¤ "${item.name}"`, 'info');
        }
    };

    // åˆ é™¤ç¤ºä¾‹æ•°æ®çš„tilesetï¼ˆé€šè¿‡ç¤ºä¾‹IDï¼‰
    function removeExampleTileset(exampleId) {
        const index = loadedTilesets.findIndex(t => t.exampleId === exampleId);
        if (index !== -1) {
            const item = loadedTilesets[index];

            try {
                // å®‰å…¨åœ°ç§»é™¤å’Œé”€æ¯tileset
                if (item.tileset && !item.tileset.isDestroyed()) {
                    viewer.scene.primitives.remove(item.tileset);
                    item.tileset.destroy();
                }
            } catch (error) {
                console.warn('ç§»é™¤tilesetæ—¶å‡ºé”™:', error);
            }

            // å–æ¶ˆåŠ è½½æ ‡è®°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            loadingTilesets.delete(item.url);

            loadedTilesets.splice(index, 1);
            updateLoadedList();
            showStatus(`å·²éšè— "${item.name}"`, 'info');
        } else {
            // å¦‚æœæ•°æ®è¿˜åœ¨åŠ è½½ä¸­å°±è¢«å–æ¶ˆï¼Œæ ‡è®°å–æ¶ˆ
            const exampleData = EXAMPLE_DATA.find(e => e.id === exampleId);
            if (exampleData && loadingTilesets.has(exampleData.url)) {
                loadingTilesets.delete(exampleData.url);
                showStatus(`å·²å–æ¶ˆåŠ è½½ "${exampleData.name}"`, 'info');
            }
        }
    }

    // æ·»åŠ æ–°çš„URLè¾“å…¥
    function addUrlToLoad() {
        const urlInput = document.getElementById('urlInput').value.trim();
        if (urlInput) {
            loadFromUrl();
        }
    }

    // æ¸…é™¤æ‰€æœ‰tileset
    function clearAllTilesets() {
        if (!viewer) {
            showStatus('åœ°å›¾è§†å›¾å°šæœªåˆå§‹åŒ–', 'error');
            return;
        }

        if (loadedTilesets.length === 0) {
            showStatus('æ²¡æœ‰éœ€è¦æ¸…é™¤çš„æ•°æ®', 'info');
            return;
        }

        // å¤åˆ¶æ•°ç»„ä»¥é¿å…åœ¨è¿­ä»£æ—¶ä¿®æ”¹
        const tilesetsCopy = [...loadedTilesets];

        tilesetsCopy.forEach(item => {
            try {
                // å®‰å…¨åœ°ç§»é™¤å’Œé”€æ¯tileset
                if (item.tileset && !item.tileset.isDestroyed()) {
                    viewer.scene.primitives.remove(item.tileset);
                    item.tileset.destroy();
                }
            } catch (error) {
                console.warn('ç§»é™¤tilesetæ—¶å‡ºé”™:', error);
            }

            // å¦‚æœæ˜¯ç¤ºä¾‹æ•°æ®ï¼Œå–æ¶ˆå¯¹åº”çš„checkbox
            if (item.exampleId) {
                const checkbox = document.getElementById(`example-${item.exampleId}`);
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.parentElement.parentElement.classList.remove('selected');
                }
            }
        });

        // æ¸…é™¤æ‰€æœ‰åŠ è½½æ ‡è®°
        loadingTilesets.clear();

        loadedTilesets = [];
        updateLoadedList();
        document.getElementById('urlInput').value = 'https://pelican-public.s3.amazonaws.com/3dtiles/agi-hq/tileset.json';
        showStatus('å·²æ¸…é™¤æ‰€æœ‰3D Tilesæ•°æ®', 'info');
    }

    // åŠ è½½é€‰ä¸­çš„ç¤ºä¾‹æ•°æ®ï¼ˆæ­¤å‡½æ•°å·²åºŸå¼ƒï¼Œæ”¹ä¸ºå³æ—¶åŠ è½½ï¼‰
    async function loadSelectedExamples() {
        const checkboxes = document.querySelectorAll('#exampleList input[type="checkbox"]:checked');

        if (checkboxes.length === 0) {
            showStatus('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç¤ºä¾‹æ•°æ®', 'error');
            return;
        }

        showStatus(`æ­£åœ¨åŠ è½½ ${checkboxes.length} ä¸ªç¤ºä¾‹æ•°æ®...`, 'info');

        for (const checkbox of checkboxes) {
            const url = checkbox.value;
            const name = checkbox.dataset.name;
            const exampleId = checkbox.dataset.exampleId;
            await loadTileset(url, name, exampleId);
        }
    }

    // URLå›è½¦é”®åŠ è½½
    document.getElementById('urlInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadFromUrl();
        }
    });

    // åˆå§‹åŒ–
    window.addEventListener('load', function() {
        try {
            initViewer();
            initTabs();
            initExampleList();
            showStatus('âœ… é¢„è§ˆå™¨å·²å°±ç»ªï¼Œè¯·è¾“å…¥æ•°æ®åœ°å€æˆ–é€‰æ‹©ç¤ºä¾‹æ•°æ®', 'success');

            // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('loadUrlBtn').addEventListener('click', loadFromUrl);
            document.getElementById('addUrlBtn').addEventListener('click', addUrlToLoad);
            document.getElementById('clearBtn').addEventListener('click', clearAllTilesets);

        } catch (error) {
            console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            showStatus('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        }
    });
</script>
</body>
</html>
